<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Abastecimentos - 2¬™ Cia PM</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <style>
        :root {
            --pm-blue-dark: #002147;
            --pm-blue-light: #003366;
            --pm-gray: #333333;
            --bg-body: #f5f7fa;
        }

        body {
            background-color: var(--bg-body);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .hero.is-pm {
            background-color: var(--pm-blue-dark);
            color: white;
            border-bottom: 4px solid #ccaa00;
        }

        .box-custom {
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: -1.5rem;
            background: #ffffff;
        }

        /* Estilo da Mensagem Flutuante Centralizada */
        #message {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            min-width: 300px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            font-weight: bold;
        }

        /* Overlay para escurecer o fundo quando a mensagem aparece (opcional) */
        .msg-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 999;
        }

        .label {
            color: var(--pm-gray);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        #preview-container {
            display: none;
            margin-top: 15px;
            border: 2px solid #dbdbdb;
            border-radius: 6px;
            padding: 8px;
            background: #fafafa;
            position: relative;
        }

        #image-preview {
            width: 100%;
            border-radius: 4px;
            display: block;
        }

        .btn-remove {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-weight: bold;
        }

        .button.is-pm-send {
            background-color: var(--pm-blue-dark);
            color: white;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .hero-body {
                padding: 1.5rem 1rem 3rem !important;
            }

            .title {
                font-size: 1.5rem !important;
                text-align: center;
            }
        }
    </style>
</head>

<body>

    <div id="overlay" class="msg-overlay"></div>
    <div id="message" class="notification"></div>

    <section class="hero is-pm">
        <div class="hero-body py-5">
            <div class="container">
                <h1 class="title has-text-white">
                    <i class="fas fa-shield-halved mr-2"></i> 2¬™ CIA - Abastecimentos
                </h1>
            </div>
        </div>
    </section>

    <main class="container is-max-desktop px-4">
        <form id="form" class="box box-custom p-5">
            <div class="field">
                <label class="label"><i class="fas fa-calendar-alt mr-1"></i> Data da Ocorr√™ncia</label>
                <div class="control has-icons-left">
                    <input class="input" type="date" name="Data" id="dataAtual" required />
                    <span class="icon is-small is-left"><i class="fas fa-calendar"></i></span>
                </div>
            </div>

            <div class="field">
                <label class="label"><i class="fas fa-car-side mr-1"></i> Prefixo da Viatura</label>
                <div class="control has-icons-left">
                    <div class="select is-fullwidth">
                        <select name="Viatura" id="viaturaSelect" required>
                            <option value="">Selecione a Viatura</option>

                            <option value="13200">13200</option>
                            <option value="13201">13201</option>
                            <option value="13202">13202</option>
                            <option value="13203">13203</option>
                            <option value="13204">13204</option>
                            <option value="13205">13205</option>
                            <option value="13206">13206</option>
                            <option value="13207">13207</option>
                            <option value="13208">13208</option>
                            <option value="13209">13209</option>
                            <option value="13210">13210</option>
                            <option value="13211">13211</option>
                            <option value="13213">13213</option>
                            <option value="13214">13214</option>
                            <option value="13219">13219</option>
                            <option value="13220">13220</option>
                            <option value="13223">13223</option>
                            <option value="13225">13225</option>
                            <option value="13226">13226</option>
                            <option value="13228">13228</option>
                            <option value="13229">13229</option>
                            <option value="13230">13230</option>
                            <option value="13231">13231</option>
                            <option value="13232">13232</option>
                            <option value="13233">13233</option>
                            <option value="13234">13234</option>
                            <option value="13280">13280</option>
                            <option value="13281">13281</option>
                            </optgroup>
                            <option value="outra">Outra (especificar em obs)</option>
                        </select>
                    </div>
                    <span class="icon is-small is-left"><i class="fas fa-hashtag"></i></span>
                </div>
            </div>

            <div class="field">
                <label class="label"><i class="fas fa-camera mr-1"></i> Foto da Nota Fiscal</label>
                <div class="control">
                    <div class="file has-name is-fullwidth is-dark">
                        <label class="file-label">
                            <input class="file-input" type="file" name="Nota" id="fileInput" accept="*/*" required />
                            <span class="file-cta">
                                <span class="file-icon"><i class="fas fa-camera"></i></span>
                                <span class="file-label">Tirar Foto da Nota</span>
                            </span>
                            <span class="file-name" id="fileNameDisplay">Nenhum arquivo capturado</span>
                        </label>
                    </div>
                </div>
                <div id="preview-container">
                    <button type="button" class="btn-remove" id="removeBtn">&times;</button>
                    <img src="" id="image-preview" alt="Preview">
                </div>
            </div>

            <div class="field">
                <label class="label">Observa√ß√µes</label>
                <div class="control">
                    <textarea class="textarea" name="Obs" placeholder="Anomalias, erros na bomba, etc."></textarea>
                </div>
            </div>

            <div class="field is-grouped pt-4">
                <div class="control is-expanded">
                    <button class="button is-pm-send is-fullwidth" type="submit" id="submit-button">
                        <i class="fas fa-paper-plane mr-2"></i> ENVIAR
                    </button>
                </div>
                <div class="control is-expanded">
                    <button class="button is-light is-fullwidth" type="button" onclick="resetForm()">
                        LIMPAR
                    </button>
                </div>
            </div>
        </form>
    </main>

    <script>
        const form = document.getElementById("form");
        const fileInput = document.getElementById("fileInput");
        const fileNameDisplay = document.getElementById("fileNameDisplay");
        const previewContainer = document.getElementById("preview-container");
        const imagePreview = document.getElementById("image-preview");
        const messageDiv = document.getElementById("message");
        const overlay = document.getElementById("overlay");
        const submitBtn = document.getElementById("submit-button");

        // Data Atual
        const hoje = new Intl.DateTimeFormat("en-CA", {
            timeZone: "America/Sao_Paulo", year: "numeric", month: "2-digit", day: "2-digit"
        }).format(new Date());
        document.getElementById("dataAtual").value = hoje;

        function showStatus(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = `notification ${type}`;
            messageDiv.style.display = "block";
            overlay.style.display = "block";

            if (type !== 'is-warning') { // Se n√£o for o de "enviando", some ap√≥s 3s
                setTimeout(() => {
                    messageDiv.style.display = "none";
                    overlay.style.display = "none";
                }, 3000);
            }
        }

        fileInput.addEventListener("change", function () {
            if (this.files && this.files[0]) {
                fileNameDisplay.textContent = this.files[0].name;
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    previewContainer.style.display = "block";
                }
                reader.readAsDataURL(this.files[0]);
            }
        });

        function resetForm() {
            form.reset();
            document.getElementById("dataAtual").value = hoje;
            previewContainer.style.display = "none";
            fileNameDisplay.textContent = "Nenhum arquivo capturado";
            messageDiv.style.display = "none";
            overlay.style.display = "none";
        }

        async function processImage(file, viatura, dataOcorrencia) {
            return new Promise((resolve) => {
                const img = new Image();
                const reader = new FileReader();
                reader.onload = (e) => img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");
                    const MAX_WIDTH = 1000;
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height *= (MAX_WIDTH / width);
                        width = MAX_WIDTH;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Gerar Data e Hora para o NOME do arquivo
                    const agora = new Date();
                    const horas = String(agora.getHours()).padStart(2, '0');
                    const minutos = String(agora.getMinutes()).padStart(2, '0');

                    // NOME: 2026-02-02_11-05_VTR-13204.jpg
                    const customFileName = `${dataOcorrencia}_${horas}-${minutos}_VTR-${viatura}.jpg`;

                    // Marca d'√°gua na imagem
                    const textoMarca = `VTR: ${viatura} | ${dataOcorrencia} ${horas}:${minutos}`;
                    ctx.fillStyle = "rgba(0, 0, 0, 0.6)";
                    ctx.fillRect(0, height - 40, width, 40);
                    ctx.font = "bold 20px Arial";
                    ctx.fillStyle = "white";
                    ctx.fillText(textoMarca, 20, height - 12);

                    resolve({
                        fileName: customFileName,
                        data: canvas.toDataURL("image/jpeg", 0.9).split(",")[1]
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        form.addEventListener("submit", async function (e) {
            e.preventDefault();
            submitBtn.disabled = true;
            showStatus("üöÄ Enviando dados, aguarde...", "is-warning is-light");

            try {
                const formData = new FormData(this);
                const obj = Object.fromEntries(formData.entries());

                if (fileInput.files.length > 0) {
                    obj.fileData = await processImage(fileInput.files[0], obj.Viatura, obj.Data);
                }

                const scriptURL = "https://script.google.com/macros/s/AKfycbyCQ9crWywcceQU6tz2kkL-hG2bltZvoR6BZWc08rLpc7E4tDR5ubdGhbUWGXwUkaqK/exec";

                const response = await fetch(scriptURL, {
                    method: "POST",
                    body: JSON.stringify(obj),
                    headers: { "Content-Type": "text/plain;charset=utf-8" }
                });

                const result = await response.json();

                if (result.status === "success") {
                    showStatus("‚úÖ Abastecimento registrado!", "is-success");
                    setTimeout(resetForm, 1000);
                } else {
                    throw new Error();
                }
            } catch (error) {
                showStatus("‚ùå Erro ao enviar. Verifique a conex√£o.", "is-danger");
            } finally {
                submitBtn.disabled = false;
            }
        });
    </script>
</body>

</html>
